<!-- habits/templates/habits/habits_list.html -->

{% extends 'base.html' %}  <!-- Extend your base template if you have one -->

{% block style %}

{% endblock %}

{% block content %}
<div class="container mt-5"> 
    <div id="notification" class="notification hidden">
        <p id="notification-message"></p>
    </div> 
    <!-- Daily Habits -->
    <h3>Daily Habits</h3>
    <div class="habit-list daily-habits d-flex flex-wrap justify-content-start">
        {% for entry in habits_with_progress %}
            {% if entry.habit.frequency == 'DAILY' %}
                <div class="habit-item">
                    <div class="habit-item" data-progress="{{ entry.progress_percentage }}" data-habit-id="{{ entry.habit.id }}">
                        <div class="progress-circle clickable" onclick="submitProgressForm({{ entry.habit.id }})">
                            <div class="circle-overlay"></div>
                            <span class="plus-icon"><i class="fa-solid fa-plus"></i></span> <!-- Plus icon -->
                            <span class="habit-name">{{ entry.habit.name }}</span>
                        </div>
                        <div class="">
                            {% if not entry.is_completed %}
                                <form id="progress-form-{{ entry.habit.id }}" action="{% url 'track_habit' entry.habit.id %}" method="post" class="mt-2">
                                    {% csrf_token %}
                                </form>
                            {% else %}
                                <span class="badge badge-success mt-2">Completed</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
    
    <!-- Weekly Habits -->
    <h3>Weekly Habits</h3>
    <div class="habit-list weekly-habits d-flex flex-wrap justify-content-start">
        {% for entry in habits_with_progress %}
            {% if entry.habit.frequency == 'WEEKLY' %}
                <div class="habit-item" data-progress="{{ entry.progress_percentage }}" data-habit-id="{{ entry.habit.id }}">
                    <div class="progress-circle clickable" onclick="submitProgressForm({{ entry.habit.id }})">
                        <div class="circle-overlay"></div>
                        <span class="plus-icon"><i class="fa-solid fa-plus"></i></span> <!-- Plus icon -->
                        <span class="habit-name">{{ entry.habit.name }}</span>
                    </div>
                    <div class="">
                        {% if not entry.is_completed %}
                            <form id="progress-form-{{ entry.habit.id }}" action="{% url 'track_habit' entry.habit.id %}" method="post" class="mt-2">
                                {% csrf_token %}
                            </form>
                        {% else %}
                            <span class="badge badge-success mt-2">Completed</span>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
{% endblock %}

{% block scripts %}
<script>
    document.querySelectorAll('.habit-item').forEach(function(item) {
        var progress = item.getAttribute('data-progress');
        var circle = item.querySelector('.progress-circle');
        circle.style.setProperty('--progress', progress + '%');
    });

    function submitProgressForm(habitId) {
        // Find the form by ID and submit it
        //let elem = document.getElementById('progress-form-' + habitId).submit();
    }

    $(document).ready(function() {
        $('.clickable').click(function() {
            console.log("Clicked")
            var habitId = $(this).closest('.habit-item').data('habit-id');
            var csrfToken = $('[name=csrfmiddlewaretoken]').val(); // Get CSRF token from any CSRF input field
            $.ajax({
                url: '/habit/track/' + habitId + '/', // Make sure this URL matches your Django URL configuration for updating habit progress
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': csrfToken,
                    'habit_id': habitId, // Assuming your Django view expects habit_id as part of the POST data
                },
                success: function(response) {
                    // Update the UI based on the response
                    // This assumes the response contains the new progress percentage and completion status
                    var progressPercentage = response.progress_percentage;
                    var isCompleted = response.is_completed;
                    handleNotificatioNmessage(response);
                    var habitItem = $('[data-habit-id=' + habitId + ']');
                    habitItem.find('.progress-circle').css('--progress', progressPercentage + '%'); // Update the progress circle
                    
                    if (isCompleted) {
                        habitItem.find('.clickable').off('click'); // Disable further clicks if habit is completed
                        habitItem.append('<span class="badge badge-success mt-2">Completed</span>'); // Add a "Completed" badge
                    }
                },
                error: function(xhr, status, error) {
                    // Handle errors
                    console.error('Error updating habit progress:', error);
                }
            });
        });
    });
    function handleNotificatioNmessage(response) {
        // Update UI to show XP gained
        /*
        'progress_percentage': progress_percentage,
            'is_completed': is_completed,
            'xp_gain': xp,
            'got_new_egg': got_new_egg,
            'num_hatched_birds': len(hatched_birds)
        */
        var msg = `You gained ${response.xp_gain} experience points!`
        if(response.got_new_egg == true) {
            msg += `\nYou also got an new Egg!`
        }
        if(response.num_hatched_birds > 0) {
            msg += `\nYou hateched ${response.num_hatched_birds} bird/s!`
        }
        showNotification(msg);
    }

    function showNotification(message) {
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');
    
        // Set notification message
        notificationMessage.innerText = message;
    
        // Show notification
        notification.classList.remove('hidden');
        notification.classList.add('show');
    
        // Hide notification after 5 seconds
        setTimeout(function() {
            hideNotification();
        }, 1500);
    }
    
    function hideNotification() {
        const notification = document.getElementById('notification');
        
        // Hide notification
        notification.classList.remove('show');
        notification.classList.add('hidden');
    }
</script>
{% endblock %}
